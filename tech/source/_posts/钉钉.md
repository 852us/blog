---
title: 钉钉
categories:
  - [钉钉, Python]
tags:
  - 钉钉
  - Python
date: 2023-07-27 14:58:03
mathjax:
---
## 钉钉机器人
### 创建钉钉群组机器人

> 1. 设置→群设置→机器人
> 2. 添加机器人
> 3. 自定义
> 4. 添加
> 5. 机器人名称：期货
> 6. 安全设置：加签
> 7. 复制：SEC4c4262656fe9585e82ed9004f3688d0ff1257aee8e79de3c1c896db7d2b3f30d，脚本中的secret变量内容。
> 8. 我已阅读并同意
> 9. 完成
> 10. 复制Webhook: `https://oapi.dingtalk.com/robot/send?access_token=a64487796eb55203949dfb7cbcd5f4cefa30ad718f2069f18bd155f5ae846784`，脚本access_token变量为等号后面的内容
>
> 注意：access_token与secret的内容需要替换为实际内容，并且需要保密。

<!--more-->

<img src="image-20230729150206740.png" alt="创建机器人" style="zoom:33%;" />

### 机器人脚本

```python
#!/usr/bin/python3

import requests
import json
import datetime
import time
import hmac
import hashlib
import base64
import urllib.parse

class dt_robot:
    def __init__(self, access_token, secret):
        self.access_token = access_token
        self.secret = secret

    def timestamp_sign(self):
        timestamp = str(round(time.time() * 1000))
        secret_enc = self.secret.encode('utf-8')
        string_to_sign = '{}\n{}'.format(timestamp, self.secret)
        string_to_sign_enc = string_to_sign.encode('utf-8')
        hmac_code = hmac.new(secret_enc, string_to_sign_enc, digestmod=hashlib.sha256).digest()
        sign = urllib.parse.quote_plus(base64.b64encode(hmac_code))

        return (timestamp, sign)

    def url(self):
        timestamp, sign = self.timestamp_sign()
        url_template = 'https://oapi.dingtalk.com/robot/send?access_token={}&timestamp={}&sign={}'
        url = url_template.format(self.access_token, timestamp, sign)
        return url

    def message_headers(self):
        return {
            'Content-Type': 'application/json'
        }

    def message_data(self, content):
        data = {
            'msgtype': 'text',
            'text': {
                'content': content
            }
        }
        return data

    def send(self, content):
        url = self.url()
        response = requests.post(url, headers=self.message_headers(),
                                 data=json.dumps(self.message_data(content)))
        if response.status_code == 200:
            print('消息发送成功')
        else:
            print('消息发送失败')

if __name__ == '__main__':
    def main():
        access_token = 'a64487796eb55203949dfb7cbcd5f4cefa30ad718f2069f18bd155f5ae846784'
        secret = 'SEC4c4262656fe9585e82ed9004f3688d0ff1257aee8e79de3c1c896db7d2b3f30d'
        content = datetime.datetime.now().strftime('%F %T')
        mintue_message = dt_robot(access_token, secret)
        mintue_message.send(content)

    main()

```



