---
title: 钉钉
categories:
  - [钉钉, Python]
tags:
  - 钉钉
  - Python
date: 2023-07-27 14:58:03
mathjax:
---
## 钉钉机器人
### 创建钉钉群组机器人

> 1. 设置→群设置→机器人
> 2. 添加机器人
> 3. 自定义
> 4. 添加
> 5. 机器人名称：期货
> 6. 安全设置：加签
> 7. 复制：SEC4c4262656fe9585e82ed9004f3688d0ff1257aee8e79de3c1c896db7d2b3f30d，脚本中的secret变量内容。
> 8. 我已阅读并同意
> 9. 完成
> 10. 复制Webhook: `https://oapi.dingtalk.com/robot/send?access_token=a64487796eb55203949dfb7cbcd5f4cefa30ad718f2069f18bd155f5ae846784`，脚本access_token变量为等号后面的内容
>
> 注意：access_token与secret的内容需要替换为实际内容，并且需要保密。

<!--more-->

<img src="image-20230729150206740.png" alt="创建机器人" style="zoom:33%;" />

### 机器人脚本

```python
#!/usr/bin/python3

import requests
import json
import datetime
import time
import hmac
import hashlib
import base64
import urllib.parse

def dingtalk_message(webhook, content):
  headers = {
    'Content-Type': 'application/json'
  }
  data = {
    'msgtype': 'text',
    'text': {
      'content': content
    }
  }
  response = requests.post(webhook, headers=headers, data=json.dumps(data))
  # print(response)
  if response.status_code == 200:
    print('消息发送成功')
  else:
    print('消息发送失败')

def minute_message(content):
  access_token = 'a64487796eb55203949dfb7cbcd5f4cefa30ad718f2069f18bd155f5ae846784'
  secret = 'SEC4c4262656fe9585e82ed9004f3688d0ff1257aee8e79de3c1c896db7d2b3f30d'
  url_template = 'https://oapi.dingtalk.com/robot/send?access_token={}&timestamp={}&sign={}'

  timestamp = str(round(time.time() * 1000))
  secret_enc = secret.encode('utf-8')
  string_to_sign = '{}\n{}'.format(timestamp, secret)
  string_to_sign_enc = string_to_sign.encode('utf-8')
  hmac_code = hmac.new(secret_enc, string_to_sign_enc, digestmod=hashlib.sha256).digest()
  sign = urllib.parse.quote_plus(base64.b64encode(hmac_code))

  url = url_template.format(access_token, timestamp, sign)
  # print(url)
  dingtalk_message(url, content)

def main():
  content =datetime.datetime.now().strftime('%F %T')
  minute_message(content)

main()

```



